version: 2

# ============================================================================
# GOLD LAYER - BUSINESS-READY MODELS
# ============================================================================
# Tests and documentation for dimensions, facts, and reports
# ============================================================================

models:
  - name: dim_customers
    description: Customer dimension with aggregated metrics and segmentation
    columns:
      - name: customer_id
        tests: [unique, not_null]
      - name: email
        tests: [unique, not_null]
      - name: customer_segment
        description: Based on purchase frequency
        tests:
          - accepted_values:
              values:
                [
                  'never_purchased',
                  'one_time',
                  'occasional',
                  'regular',
                  'champion',
                ]
      - name: value_tier
        description: Based on lifetime revenue
        tests:
          - accepted_values:
              values:
                ['no_value', 'low_value', 'medium_value', 'high_value', 'vip']
      - name: activity_status
        description: Based on recency of orders
        tests:
          - accepted_values:
              values: ['never_ordered', 'active', 'at_risk', 'churned']

  - name: dim_categories
    description: Product category dimension with department grouping
    columns:
      - name: category_id
        description: Primary key - unique category identifier
        tests: [unique, not_null]
      - name: category_name
        description: Display name of the category
        tests: [not_null]
      - name: department
        description: Parent department grouping
        tests: [not_null]

  - name: dim_products
    description: Product dimension with sales metrics and performance analysis
    columns:
      - name: product_id
        description: Primary key - unique product identifier
        tests: [unique, not_null]
      - name: product_name
        description: Product name
        tests: [not_null]
      - name: sku
        description: Stock keeping unit - unique product code
        tests: [unique, not_null]
      - name: total_revenue
        description: Total revenue generated from product sales
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: avg_discount_percentage
        description: Average discount percentage applied to this product
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "between 0 and 100"
      - name: performance_tier
        description: Product performance classification based on revenue
        tests:
          - accepted_values:
              values:
                [
                  'no_sales',
                  'low_performer',
                  'moderate_performer',
                  'strong_performer',
                  'top_performer',
                ]
      - name: margin_tier
        description: Profit margin classification
        tests:
          - accepted_values:
              values: ['no_sales', 'low_margin', 'medium_margin', 'high_margin']
      - name: sales_status
        description: Current sales activity status
        tests:
          - accepted_values:
              values: ['never_sold', 'active', 'slow_moving', 'stale']

  - name: fct_orders
    description: Orders fact table with denormalized customer info
    columns:
      - name: order_id
        tests: [unique, not_null]
      - name: customer_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_customers')
                field: customer_id

  - name: fct_order_items
    description: Order line items fact table with product and profit data
    columns:
      - name: order_item_id
        tests: [unique, not_null]
      - name: order_id
        tests: [not_null]
      - name: product_id
        tests: [not_null]
      - name: customer_id
        tests: [not_null]

  - name: rpt_customer_metrics
    description: Customer analytics report by segment, tier, and channel
    columns:
      - name: customer_count
        tests: [not_null]

  - name: rpt_monthly_sales
    description: Monthly sales performance report with growth metrics
    columns:
      - name: order_month
        description: First day of the month for aggregation
        tests: [unique, not_null]
      - name: year_month
        description: Year-month in YYYY-MM format
        tests: [unique, not_null]
      - name: total_orders
        description: Total number of orders in the month
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: total_revenue
        description: Total revenue for the month
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: avg_order_value
        description: Average order value for the month
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: unique_customers
        description: Number of unique customers who placed orders
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: completion_rate_pct
        description: Percentage of orders completed
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "between 0 and 100"
      - name: cancellation_rate_pct
        description: Percentage of orders cancelled
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "between 0 and 100"

  - name: rpt_product_performance
    description: Product sales and profit analysis report
    columns:
      - name: product_id
        tests: [unique, not_null]
      - name: performance_tier
        tests:
          - accepted_values:
              values:
                [
                  'top_performer',
                  'strong_performer',
                  'moderate_performer',
                  'low_performer',
                ]
      - name: margin_tier
        tests:
          - accepted_values:
              values: ['high_margin', 'medium_margin', 'low_margin']

  - name: rpt_sales_by_category
    description: Sales performance report aggregated by product category
    columns:
      - name: category_id
        description: Unique category identifier
        tests: [unique, not_null]
      - name: category_name
        description: Display name of the category
        tests: [not_null]
      - name: department
        description: Parent department grouping
        tests: [not_null]
      - name: total_revenue
        description: Total revenue generated by this category
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: total_orders
        description: Number of orders containing products from this category
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: performance_tier
        description: Category performance classification based on revenue
        tests:
          - accepted_values:
              values:
                [
                  'no_sales',
                  'low_performer',
                  'moderate_performer',
                  'strong_performer',
                  'top_performer',
                ]

  - name: fct_reviews
    description: Customer product reviews fact table with calculated metrics
    columns:
      - name: review_id
        description: Primary key - unique review identifier
        tests:
          - unique
          - not_null
      - name: product_id
        description: Foreign key to products
        tests:
          - not_null
      - name: customer_id
        description: Foreign key to customers
        tests:
          - not_null
      - name: rating
        description: Product rating from 1 (poor) to 5 (excellent)
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5]
      - name: review_date
        description: Date when the review was submitted
        tests:
          - not_null
      - name: rating_category
        description: Rating classification - Poor, Average, or Good
        tests:
          - accepted_values:
              values: ['Poor', 'Average', 'Good']

  - name: rpt_product_ratings
    description: Product review ratings and satisfaction metrics report
    columns:
      - name: product_id
        description: Unique product identifier
        tests:
          - unique
          - not_null
      - name: product_name
        description: Product name
        tests:
          - not_null
      - name: total_reviews
        description: Total number of reviews for this product
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: avg_rating
        description: Average rating (1-5 scale)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "between 1 and 5"
      - name: positive_review_pct
        description: Percentage of reviews with 4 or 5 star ratings
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "between 0 and 100"

  - name: rpt_customer_review_activity
    description: Customer review behavior and engagement metrics report
    columns:
      - name: customer_id
        description: Unique customer identifier
        tests:
          - unique
          - not_null
      - name: email
        description: Customer email address
        tests:
          - not_null
      - name: total_reviews_written
        description: Total number of reviews written by this customer
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"
      - name: avg_rating_given
        description: Average rating this customer gives
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "between 1 and 5"
      - name: reviewer_type
        description: Classification of reviewer behavior
        tests:
          - accepted_values:
              values: ['Harsh Critic', 'Balanced Reviewer', 'Enthusiastic Reviewer']

